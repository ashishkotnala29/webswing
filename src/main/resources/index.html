<html>
<head>
<title>Swingers party</title>
<script src="socket.io.min.js" type="text/javascript" charset="utf-8"></script>
<link rel="stylesheet" href="jquery-ui.css" />
<script src="http://code.jquery.com/jquery-1.8.2.js"></script>
<script src="http://code.jquery.com/ui/1.9.0/jquery-ui.js"></script>

<script type="text/javascript" charset="utf-8">
	
    var socket = io.connect('http://localhost:8080', {
        'reconnection delay' : 2000,
        'force new connection' : true
      });

    var seq=0;
    var earlyReqMap= {}; 
    
    function processRequest(data)
    {
        
    	var canvas = document.getElementById(data.windowInfo.id);
    	if(canvas==null){
    		createCanvasWinodow(data.windowInfo.id,data.windowInfo.title,data.windowInfo.width,data.windowInfo.height);
    		canvas=document.getElementById(data.windowInfo.id);
        }
   	 	var context = canvas.getContext("2d");
   		if(data.type=="paint"){
    	  	var imageObj = new Image();
          	imageObj.onload = function() {
            	context.drawImage(imageObj, data.x, data.y);
            	var currentDialog=$("#"+data.windowInfo.id+"Window");
            	if(currentDialog.dialog("isOpen")==false){
                	currentDialog.dialog("open");
                }
            	if(data.windowInfo.hasFocus){
            		currentDialog.dialog("moveToTop");
            	}
          	};
          	imageObj.src = "swing/"+data.filename;
	  	}else if(data.type == "copyArea"){
          	var imageDataToCopy = context.getImageData(data.x, data.y, data.width, data.height);
          	context.putImageData(imageDataToCopy, data.x + data.dx, data.y + data.dy);
      	}
    }

	function createCanvasWinodow(name,title,width,height){
		$("#root").append('<div id="'+name+'Window"><canvas id="'+name+'" width="'+width+'" height="'+height+'"/></div>');
		$("#"+name+"Window" ).dialog({
            width: "auto",
            heigth: "auto",
            title: title,
            resizable: "false"
        });	
	}
       
    socket.on('message', function(data) {
    	  if(seq==0 || seq==data.seq){
			  processRequest(data);	
    		  seq++;
              while(earlyReqMap[seq]!=null){
                  var tmp=earlyReqMap[seq];
                  processRequest(tmp,context);
                  delete earlyReqMap[seq];
                  seq++;       
              }
          }else{
        	  earlyReqMap[data.seq]=data;      
          }  
      });

  	  socket.on('connect', function() {
           // connection established, now we can send an objects
			seq=0;
           // send json-object to server
           //var obj = ...
           socket.send('connection test successful');
 	  });
    </script>
</head>
<body bgcolor="#AAA">
	<div id="root"></div>
</body>
</html>