<html>
<head>
<title>Swingers party</title>
<script src="socket.io.min.js" type="text/javascript" charset="utf-8"></script>
<script
	src="http://ajax.googleapis.com/ajax/libs/jquery/1.2.6/jquery.min.js"
	type="text/javascript" charset="utf-8"></script>

<script type="text/javascript" charset="utf-8">
	
    var socket = io.connect('http://localhost:8080', {
        'reconnection delay' : 2000,
        'force new connection' : true
      });

    var seq=0;
    var earlyReqMap= {}; 

    function processRequest(data,context)
    {
  	  if(data.type=="paint"){
    	  var imageObj = new Image();
          imageObj.onload = function() {
            	context.drawImage(imageObj, data.x, data.y);
          };
          imageObj.src = "swing/"+data.filename;
	  }else if(data.type == "copyArea"){
          var imageDataToCopy = context.getImageData(data.x, data.y, data.width, data.height);
          context.putImageData(imageDataToCopy, data.x + data.dx, data.y + data.dy);
      }
    }
        
    socket.on('message', function(data) {
    	  var canvas = document.getElementById("myCanvas");
    	  var context = canvas.getContext("2d");
    	  if(seq==0 || seq==data.seq){
			  processRequest(data,context);	
    		  seq++;
              while(earlyReqMap[seq]!=null){
                  var tmp=earlyReqMap[seq];
                  processRequest(tmp,context);
                  delete earlyReqMap[seq];
                  seq++;       
              }
          }else{
        	  earlyReqMap[data.seq]=data;      
          }  
      });

  	  socket.on('connect', function() {
           // connection established, now we can send an objects
			seq=0;
           // send json-object to server
           //var obj = ...
           socket.send('connection test successful');
 	  });
    </script>
</head>
<body>
	<div >
		<canvas id="myCanvas" width="1000px" height="800px" style="padding-left: 0; padding-right: 0; margin-left: auto; margin-right: auto; display: block;"></canvas>
	</div>
</body>
</html>