<!DOCTYPE html>
<html lang="en">
<head>
<title>Webswing</title>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta charset="utf-8" />
<link rel="stylesheet" href="css/webswing.css" />
<link rel="stylesheet" href="javascript/templates/dialog.css" />
<link rel="stylesheet" href="javascript/templates/bootstrap.css" />
<link rel="stylesheet" href="javascript/templates/base.css" />
<script src="javascript/jquery.js"></script>
</head>
<body>
	<div id="commonDialog" class="webswing-dialog-container">
		<div class="webswing-dialog-backdrop"></div>
		<div class="webswing-dialog">
			<div class="webswing-dialog-modal">
				<div class="webswing-dialog-modal-content">
					<div id="webswing-header"></div>
					<div id="webswing-content">
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
		var user;
		login(loadApps);
	
		function login(successCallback) {
			verify(successCallback, function() {
				window.location.href = 'login';
			});
		}

		function verify(successCallback, failCallback) {
			$.ajax({
				xhrFields : {
					withCredentials : true
				},
				type : 'GET',
				url : 'login?verify',
				success : function(data, textStatus, request) {
					user = request.getResponseHeader('webswingUsername');
					if (successCallback != null) {
						successCallback();
					}
				},
				error : function(data) {
					if (failCallback != null) {
						failCallback();
					}
				}
			});
		}
		
		function loadApps(){
			$.ajax({
				xhrFields : {
					withCredentials : true
				},
				type : 'GET',
				url : 'rest/apps',
				success : function(data, textStatus, request) {
					show(JSON.parse(data));
				},
				error : function(data) {
					if (failCallback != null) {
						failCallback();
					}
				}
			});
		}
		function logout() {
			$.ajax({
				xhrFields : {
					withCredentials : true
				},
				type : 'GET',
				url : 'logout',
				data : '',
				success : done,
				error : done
			});
			function done(data) {
				
			}
		}
		
		function show(apps) {
            var header = '';
            header = '<span class="pull-right"><a href="javascript:;" id="logout">Logout</a></span>';
            header = header + '<h4 class="modal-title" id="myModalLabel">Hello <span>' + user + '</span>. ';
            header = header + 'Select your application:</h4>';
			$('#webswing-header').html(header);
			$('#logout').click(function () {
				api.logout();
			});
            var content;
            if (apps == null || apps.length === 0) {
                header = null;
                content = '<p>Sorry, there is no application available for you.</p>';
            } else {
                content = '<div class="row">';
                for (var i in apps) {
                    var app = apps[i];
                    if (app.name === 'adminConsoleApplicationName') {
                        content += '<div class="col-xs-4 col-sm-3 col-md-2"><div class="thumbnail" style="max-width: 155px" onclick="window.location.href = \'admin\';"><img src="admin/img/admin.png" class="img-thumbnail"/><div class="caption">Admin console</div></div></div>';
                    } else {
                        content += '<div class="col-xs-4 col-sm-3 col-md-2"><div class="thumbnail" style="max-width: 155px" onclick="window.location.href = \''
								+ app.url
								+ '\';"><img src="'
                                + getImageString(app.base64Icon)
                                + '" class="img-thumbnail"/><div class="caption">' + app.name + '</div></div></div>';
                    }
                }
			}
			$('#webswing-content').html(content);
		}
		function getImageString(data) {
			if (typeof data === 'object') {
				var binary = '';
				var bytes = new Uint8Array(data.buffer, data.offset, data.limit - data.offset);
				for ( var i = 0, l = bytes.byteLength; i < l; i++) {
					binary += String.fromCharCode(bytes[i]);
				}
				data = window.btoa(binary);
			}
			return 'data:image/png;base64,' + data;
		}

	</script>
</body>
</html>